# 退款流程设计

## 一、退款状态定义

### 1.1 状态层级结构

退款流程分为**5个大状态**,每个大状态下有**详细子状态**用于系统内部流转跟踪。

```
退款流程
├─ 1. 等待审核 (REVIEWING)
│   ├─ 1.1 系统审核中
│   └─ 1.2 人工审核中
│
├─ 2. 供应商确认中 (SUPPLIER_CONFIRMING)
│   └─ 2.1 等待供应商确认
│
├─ 3. 退款处理中 (REFUND_PROCESSING)
│   ├─ 3.1 供应商已确认
│   └─ 3.2 退款中
│
├─ 4. 退款完成 (COMPLETED)
│   ├─ 4.1 退款成功
│   └─ 4.2 退款失败
│
└─ 5. 已关闭 (CLOSED)
    ├─ 5.1 审核拒绝
    └─ 5.2 用户取消
```

---

### 1.2 大状态定义

| 大状态码 | 大状态名称 | 说明 | 用户端显示 | 是否可操作 |
|---------|-----------|------|-----------|-----------|
| 1 | 等待审核 | 退款申请提交后,雪哒APP正在审核 | 审核中 | 可取消 |
| 2 | 供应商确认中 | 雪哒APP审核通过,等待供应商(自我游)确认 | 处理中 | 不可取消 |
| 3 | 退款处理中 | 供应商已确认,正在退款给用户 | 退款中 | 不可取消 |
| 4 | 退款完成 | 退款流程结束(成功或失败) | 已完成 | 查看结果 |
| 5 | 已关闭 | 退款申请被拒绝或取消 | 已关闭 | 可重新申请 |

---

### 1.3 详细子状态定义

| 子状态码 | 子状态名称 | 所属大状态 | 说明 | 运营后台显示 | 系统操作 |
|---------|-----------|-----------|------|-------------|---------|
| 1.1 | 系统审核中 | 等待审核 | 系统自动判断是否满足自动退款条件 | 系统审核中 | 自动流转 |
| 1.2 | 人工审核中 | 等待审核 | 不满足自动退款条件,等待客服审核 | 人工审核中 | 客服操作 |
| 2.1 | 等待供应商确认 | 供应商确认中 | 已提交自我游,等待供应商处理 | 等待供应商确认 | 等待回调 |
| 3.1 | 供应商已确认 | 退款处理中 | 自我游已同意退款,准备退款给用户 | 供应商已确认 | 自动流转 |
| 3.2 | 退款中 | 退款处理中 | 正在调用支付接口退款给用户 | 退款中 | 自动流转 |
| 4.1 | 退款成功 | 退款完成 | 退款已成功到账 | 退款成功 ✅ | 流程结束 |
| 4.2 | 退款失败 | 退款完成 | 退款接口调用失败,需人工处理 | 退款失败 ⚠️ | 客服介入 |
| 5.1 | 审核拒绝 | 已关闭 | 不符合退款条件,审核拒绝 | 审核拒绝 | 流程结束 |
| 5.2 | 用户取消 | 已关闭 | 用户主动取消退款申请 | 用户取消 | 流程结束 |

---

## 二、自动退款 vs 人工审核判断规则

### 2.1 自动退款条件(免审核,系统直接处理)

**适用场景**:
1. **时间规则**:使用日期前3天(不含)发起退款
2. **订单状态**:未核销(未使用)
3. **退款次数**:该订单首次申请退款
4. **特殊情况**:
   - 恶劣天气停运(雪场官方公告)
   - 系统故障导致无法使用
   - 重复扣款

**自动退款金额**:
- 全额退款(100%)
- 无手续费

**处理时效**:
- 状态流转:待审核 → 自动通过 → 退款中 → 退款成功
- 预计到账:1-3个工作日

---

### 2.2 人工审核条件(需人工介入)

**适用场景**:
1. **时间规则**:
   - 使用前1-2天发起退款(需扣20%手续费)
   - 使用当天发起退款(按规则不可退,但可能有特殊情况)
   - 使用日期后发起退款(过期退款)

2. **订单状态异常**:
   - 已核销(已使用)的订单
   - 部分核销(多日订单部分使用)

3. **特殊申请**:
   - 用户提供特殊理由(如生病、航班取消等)
   - 退款次数≥2次(可能存在滥用)
   - 退款金额异常(如申请退款金额>订单金额)

4. **风控标记**:
   - 用户账号有异常行为记录
   - 短期内频繁退款(7天内≥3次)

**人工审核要素**:
- 核实用户退款理由
- 检查订单核销状态
- 判断是否符合退改规则
- 决定退款金额(全额/扣手续费/拒绝)

---

## 三、退款流程图

### 3.1 完整流程图(基于5大状态)

```
用户发起退款申请
    ↓
┌─────────────────────────────────────────────┐
│ 大状态1: 等待审核 (REVIEWING)                │
├─────────────────────────────────────────────┤
│ 子状态1.1: 系统审核中                        │
│   ↓                                         │
│   系统自动判断退款条件                       │
│   ├─ 满足自动退款? → 进入[供应商确认中]      │
│   └─ 不满足? → 子状态1.2                     │
│                                             │
│ 子状态1.2: 人工审核中                        │
│   ↓                                         │
│   客服审核                                  │
│   ├─ 同意退款? → 进入[供应商确认中]          │
│   ├─ 拒绝退款? → 进入[已关闭]                │
│   └─ 用户取消? → 进入[已关闭]                │
└─────────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────────┐
│ 大状态2: 供应商确认中 (SUPPLIER_CONFIRMING)  │
├─────────────────────────────────────────────┤
│ 子状态2.1: 等待供应商确认                    │
│   ↓                                         │
│   调用自我游退款接口,等待供应商处理          │
│   （自我游内部流程:核销状态检查、库存回退等）│
│   ├─ 供应商同意? → 进入[退款处理中]          │
│   └─ 供应商拒绝? → 进入[已关闭]              │
└─────────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────────┐
│ 大状态3: 退款处理中 (REFUND_PROCESSING)      │
├─────────────────────────────────────────────┤
│ 子状态3.1: 供应商已确认                      │
│   ↓                                         │
│   自我游已同意退款,准备退款给用户            │
│   ↓                                         │
│ 子状态3.2: 退款中                            │
│   ↓                                         │
│   调用支付宝/微信退款接口                    │
│   ├─ 成功? → 进入[退款完成-成功]             │
│   └─ 失败? → 进入[退款完成-失败]             │
└─────────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────────┐
│ 大状态4: 退款完成 (COMPLETED)                │
├─────────────────────────────────────────────┤
│ 子状态4.1: 退款成功 ✅                       │
│   退款已到账,流程结束                        │
│                                             │
│ 子状态4.2: 退款失败 ⚠️                        │
│   支付接口失败,客服介入处理                  │
└─────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│ 大状态5: 已关闭 (CLOSED)                     │
├─────────────────────────────────────────────┤
│ 子状态5.1: 审核拒绝 ❌                       │
│   不符合退款条件,审核拒绝                    │
│                                             │
│ 子状态5.2: 用户取消 ❌                       │
│   用户主动撤销申请,流程结束                  │
└─────────────────────────────────────────────┘
```

---

### 3.2 大状态流转图(用户视角)

```
                 ┌──────────────┐
                 │ 用户发起退款  │
                 └──────┬───────┘
                        ↓
        ┌───────────────────────────┐
        │  大状态1: 等待审核         │
        │  (用户看到: "审核中")     │
        │                           │
        │  - 系统自动判断            │
        │  - 或人工审核              │
        └──────┬────────────────────┘
               │
       ┌───────┼───────┐
       │       │       │
       ↓       ↓       ↓
┌──────────┐ ┌──────────────┐ ┌──────────┐
│大状态5   │ │ 大状态2       │ │大状态5   │
│已关闭    │ │供应商确认中   │ │已关闭    │
│          │ │              │ │          │
│用户取消  │ │(用户看到:     │ │审核拒绝  │
│❌       │ │"处理中")      │ │❌       │
└──────────┘ └──────┬───────┘ └──────────┘
                    │
            ┌───────┼───────┐
            │       │       │
            ↓       ↓       ↓
     ┌──────────┐ ┌──────────┐ ┌──────────┐
     │大状态3   │ │大状态3   │ │大状态5   │
     │退款处理中│ │退款处理中│ │已关闭    │
     │          │ │          │ │          │
     │供应商已  │ │退款中    │ │供应商    │
     │确认      │ │          │ │拒绝      │
     └────┬─────┘ └────┬─────┘ └──────────┘
          │            │
          └─────┬──────┘
                ↓
        ┌───────────────┐
        │  大状态4       │
        │  退款完成      │
        │                │
        │  ├─ 退款成功✅ │
        │  └─ 退款失败⚠️  │
        └───────────────┘
```

---

### 3.3 详细子状态流转图(运营后台视角)

```
用户发起退款
    ↓
[1.1 系统审核中]
    ├─ 满足自动退款条件 → [2.1 等待供应商确认]
    ├─ 不满足条件 → [1.2 人工审核中]
    └─ 用户取消 → [5.2 用户取消]

[1.2 人工审核中]
    ├─ 客服同意退款 → [2.1 等待供应商确认]
    ├─ 客服拒绝退款 → [5.1 审核拒绝]
    └─ 用户取消 → [5.2 用户取消]

[2.1 等待供应商确认]
    ↓ (调用自我游退款接口,等待回调或轮询状态)
    ├─ 自我游同意退款 → [3.1 供应商已确认]
    └─ 自我游拒绝退款 → [5.1 审核拒绝](供应商拒绝)

[3.1 供应商已确认]
    ↓ (自动流转,准备退款给用户)
[3.2 退款中]
    ↓ (调用支付宝/微信退款接口)
    ├─ 支付接口成功 → [4.1 退款成功] ✅
    └─ 支付接口失败 → [4.2 退款失败] ⚠️

[4.2 退款失败]
    └─ 客服手动处理 → 重试[3.2] → [4.1 退款成功]
```

---

## 四、业务场景示例

### 4.1 场景1:提前3天以上退款(自动通过)

**用户操作**:
- 购买日期:2025-01-15
- 使用日期:2025-01-20
- 退款申请时间:2025-01-16 10:00(使用前4天)

**系统处理**:
1. 状态:[待审核] → 系统计算:使用前4天 ≥ 3天 ✅
2. 状态:[自动通过] → 无需人工审核
3. 状态:[退款中] → 调用支付宝/微信退款接口
4. 状态:[退款成功] → 全额退款¥320

**用户看到**:
```
退款申请已提交
 ↓ (5秒内)
退款已通过,预计1-3个工作日到账
 ↓ (1-3天)
退款成功,¥320已退回您的支付账户
```

---

### 4.2 场景2:使用前1天退款(人工审核,扣20%手续费)

**用户操作**:
- 购买日期:2025-01-15
- 使用日期:2025-01-20
- 退款申请时间:2025-01-19 10:00(使用前1天)

**系统处理**:
1. 状态:[待审核] → 系统计算:使用前1天,不满足自动退款条件
2. 状态:[人工审核中] → 推送给客服工作台
3. 客服审核:
   - 检查订单:未核销 ✅
   - 退款理由:临时有事无法去
   - 退改规则:使用前1-2天扣20%手续费
   - 审核决定:同意退款,退款金额¥320 × 80% = ¥256
4. 状态:[已同意] → 自动流转
5. 状态:[退款中] → 调用支付接口
6. 状态:[退款成功] → 实际退款¥256

**用户看到**:
```
退款申请已提交,预计2小时内审核完成
 ↓ (1小时后)
退款申请已通过
根据退改规则,使用前1天退款扣除20%手续费
退款金额:¥256(原价¥320 - 手续费¥64)
 ↓ (1-3天)
退款成功,¥256已退回您的支付账户
```

---

### 4.3 场景3:使用当天退款(人工审核,拒绝)

**用户操作**:
- 购买日期:2025-01-15
- 使用日期:2025-01-20
- 退款申请时间:2025-01-20 08:00(使用当天)

**系统处理**:
1. 状态:[待审核] → 系统计算:使用当天,不满足自动退款条件
2. 状态:[人工审核中] → 推送给客服工作台
3. 客服审核:
   - 检查订单:未核销
   - 退款理由:睡过头了来不及去
   - 退改规则:使用当天不可退改
   - 审核决定:拒绝退款
4. 状态:[已拒绝]

**用户看到**:
```
退款申请已提交,预计2小时内审核完成
 ↓ (1小时后)
退款申请被拒绝
拒绝原因:根据产品退改规则,使用当天不可退改
如有疑问请联系客服:400-xxx-xxxx
```

---

### 4.4 场景4:恶劣天气停运(自动通过,特殊情况)

**触发条件**:
- 雪场官方发布停运公告(如暴风雪、设备故障)
- 系统标记当天所有订单为"可自动退款"

**用户操作**:
- 购买日期:2025-01-15
- 使用日期:2025-01-20
- 退款申请时间:2025-01-20 10:00(使用当天)
- 触发条件:万龙雪场2025-01-20因暴风雪停运

**系统处理**:
1. 状态:[待审核] → 系统检测到"雪场停运标记" ✅
2. 状态:[自动通过] → 特殊情况免审核
3. 状态:[退款中] → 调用支付接口
4. 状态:[退款成功] → 全额退款¥320

**用户看到**:
```
退款申请已提交
 ↓ (10秒内)
退款已通过(雪场停运,全额退款)
预计1-3个工作日到账
 ↓ (1-3天)
退款成功,¥320已退回您的支付账户
```

---

### 4.5 场景5:连续5天购买,部分使用后退款(人工审核)

**用户操作**:
- 购买日期:2025-01-15
- 使用日期:2025-01-20 至 2025-01-24(连续5天)
- 订单结构:1主订单 + 5子订单
- 核销情况:
  - 子订单1(2025-01-20):已核销 ✅
  - 子订单2(2025-01-21):已核销 ✅
  - 子订单3(2025-01-22):未核销
  - 子订单4(2025-01-23):未核销
  - 子订单5(2025-01-24):未核销
- 退款申请时间:2025-01-21 18:00
- 退款理由:临时有事,后面3天不去了

**系统处理**:
1. 状态:[待审核] → 系统检测到"部分核销",不满足自动退款条件
2. 状态:[人工审核中] → 推送给客服工作台
3. 客服审核:
   - 检查核销状态:子订单1、2已使用,子订单3、4、5未使用
   - 可退子订单:3(2025-01-22,使用前1天)、4(使用前2天)、5(使用前3天)
   - 退款规则:
     - 子订单3:使用前1天,扣20% → ¥320 × 80% = ¥256
     - 子订单4:使用前2天,扣20% → ¥320 × 80% = ¥256
     - 子订单5:使用前3天,免费退 → ¥320
   - 总退款金额:¥256 + ¥256 + ¥320 = ¥832
   - 审核决定:同意退款
4. 状态:[已同意] → 自动流转
5. 状态:[退款中] → 调用支付接口
6. 状态:[退款成功] → 实际退款¥832

**用户看到**:
```
退款申请已提交,预计2小时内审核完成
 ↓ (2小时后)
退款申请已通过(部分退款)

退款明细:
• 2025-01-20:已使用,不可退
• 2025-01-21:已使用,不可退
• 2025-01-22:未使用,退¥256(扣20%手续费)
• 2025-01-23:未使用,退¥256(扣20%手续费)
• 2025-01-24:未使用,全额退¥320

总退款金额:¥832
 ↓ (1-3天)
退款成功,¥832已退回您的支付账户
```

---

## 五、退款规则总结表

| 退款时间 | 订单状态 | 自动/人工 | 手续费 | 退款金额 |
|---------|---------|----------|--------|---------|
| 使用前3天(不含) | 未核销 | 自动通过 | 0% | 100% |
| 使用前1-2天 | 未核销 | 人工审核 | 20% | 80% |
| 使用当天 | 未核销 | 人工审核 | 通常拒绝 | 0% |
| 使用日期后 | 未核销 | 人工审核 | 根据情况 | 根据情况 |
| 任意时间 | 已核销 | 人工审核 | 通常拒绝 | 0% |
| 雪场停运 | 任意 | 自动通过 | 0% | 100% |
| 系统故障 | 任意 | 自动通过 | 0% | 100% |
| 连续购买 | 部分核销 | 人工审核 | 按天计算 | 未使用日期可退 |

---

## 六、后台管理界面

### 6.1 运营后台-退款工作台

```
退款管理

[标签页] 待审核(23) | 审核中(12) | 已完成(1,234) | 已拒绝(45)

[筛选] 退款时间 ▼ | 订单类型 ▼ | 退款金额 ▼ | [搜索] 订单号/用户手机号

待审核列表:
┌────────┬──────────┬────────┬────────┬────────┬────────┬────────┐
│订单号   │用户       │产品     │使用日期 │退款金额 │申请时间 │操作     │
├────────┼──────────┼────────┼────────┼────────┼────────┼────────┤
│2025... │138***89  │成人全日 │01-22   │¥256    │01-20   │[审核]  │
│        │          │票-平日  │        │(扣20%) │10:30   │        │
├────────┼──────────┼────────┼────────┼────────┼────────┼────────┤
│2025... │159***76  │住滑套餐 │01-25   │¥1,280  │01-20   │[审核]  │
│        │          │2天1晚   │~01-27  │(全额)  │14:20   │        │
└────────┴──────────┴────────┴────────┴────────┴────────┴────────┘
```

### 6.2 审核详情页

```
退款审核详情

┌────────────────────────────────────────────────────────┐
│ 订单信息                                                │
├────────────────────────────────────────────────────────┤
│ 订单号:2025011500123                                   │
│ 用户:138****5678                                       │
│ 产品:成人全日票-平日(万龙滑雪场)                        │
│ 订单金额:¥320                                          │
│ 使用日期:2025-01-22                                    │
│ 购买时间:2025-01-15 10:30                              │
│ 核销状态:未核销                                        │
└────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────┐
│ 退款申请                                                │
├────────────────────────────────────────────────────────┤
│ 申请时间:2025-01-20 10:00                              │
│ 申请金额:¥320                                          │
│ 退款理由:临时有事无法前往                               │
│ 附件:[查看图片]                                        │
└────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────┐
│ 系统自动判断                                            │
├────────────────────────────────────────────────────────┤
│ 退款时间:使用前2天                                     │
│ 退改规则:使用前1-2天扣除20%手续费                       │
│ 建议退款金额:¥256(原价¥320 - 手续费¥64)                │
│ 是否可自动退款:❌ 否(需人工审核)                       │
└────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────┐
│ 用户历史                                                │
├────────────────────────────────────────────────────────┤
│ 总订单数:12                                            │
│ 退款次数:1                                             │
│ 风控标记:无                                            │
└────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────┐
│ 审核操作                                                │
├────────────────────────────────────────────────────────┤
│ [同意退款]                                             │
│   退款金额:[¥256] (建议¥256)                           │
│   备注:[填写审核说明]                                  │
│                                                         │
│ [拒绝退款]                                             │
│   拒绝原因:[选择拒绝理由]                              │
│                                                         │
│ [需要补充资料]                                         │
│   需要补充:[填写需要用户补充的资料]                     │
└────────────────────────────────────────────────────────┘
```

---

## 七、数据库设计(退款相关表)

### 7.1 退款申请表 `refund_requests`

```sql
CREATE TABLE refund_requests (
    refund_id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '退款ID',
    order_id BIGINT NOT NULL COMMENT '主订单ID',
    sub_order_ids VARCHAR(500) COMMENT '子订单ID列表(逗号分隔,多日订单)',
    user_id BIGINT NOT NULL COMMENT '用户ID',

    -- 金额信息
    order_amount DECIMAL(10,2) NOT NULL COMMENT '订单总金额',
    refund_amount DECIMAL(10,2) NOT NULL COMMENT '申请退款金额',
    actual_refund_amount DECIMAL(10,2) COMMENT '实际退款金额(审核后)',
    service_fee DECIMAL(10,2) DEFAULT 0 COMMENT '手续费',

    -- 退款状态
    status TINYINT NOT NULL DEFAULT 0 COMMENT '退款状态:0待审核,10自动通过,20人工审核中,21补充资料中,30已同意,31已拒绝,40退款中,50退款成功,51退款失败,99已取消',

    -- 退款原因
    reason_type TINYINT COMMENT '退款理由类型:1临时有事,2行程变更,3天气原因,4其他',
    reason_text TEXT COMMENT '退款理由详细描述',
    attachment_urls VARCHAR(1000) COMMENT '附件URLs(逗号分隔)',

    -- 审核信息
    is_auto_approved TINYINT DEFAULT 0 COMMENT '是否自动通过:0否,1是',
    reviewer_id BIGINT COMMENT '审核人ID',
    review_time DATETIME COMMENT '审核时间',
    review_remark TEXT COMMENT '审核备注',
    reject_reason VARCHAR(500) COMMENT '拒绝原因',

    -- 退款处理
    refund_method VARCHAR(50) COMMENT '退款方式:alipay/wechat/bank',
    refund_account VARCHAR(100) COMMENT '退款账户',
    refund_transaction_id VARCHAR(100) COMMENT '退款流水号',
    refund_time DATETIME COMMENT '退款完成时间',
    refund_failure_reason VARCHAR(500) COMMENT '退款失败原因',

    -- 时间戳
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '申请时间',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    INDEX idx_order_id (order_id),
    INDEX idx_user_id (user_id),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at)
) COMMENT='退款申请表';
```

### 7.2 退款状态流转日志表 `refund_status_logs`

```sql
CREATE TABLE refund_status_logs (
    log_id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '日志ID',
    refund_id BIGINT NOT NULL COMMENT '退款ID',
    from_status TINYINT COMMENT '原状态',
    to_status TINYINT NOT NULL COMMENT '新状态',
    operator_id BIGINT COMMENT '操作人ID:系统自动为0',
    operator_type TINYINT COMMENT '操作人类型:0系统,1用户,2客服',
    remark TEXT COMMENT '备注',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '操作时间',

    INDEX idx_refund_id (refund_id),
    INDEX idx_created_at (created_at)
) COMMENT='退款状态流转日志表';
```

---

## 八、接口设计(关键接口)

### 8.1 用户发起退款

**接口**: `POST /api/refund/apply`

**请求参数**:
```json
{
    "order_id": 2025011500123,
    "sub_order_ids": [1, 3, 5],  // 可选,多日订单部分退款时填写
    "reason_type": 1,             // 1临时有事,2行程变更,3天气原因,4其他
    "reason_text": "临时有事无法前往",
    "attachment_urls": ["https://..."]  // 可选
}
```

**响应**:
```json
{
    "code": 0,
    "msg": "退款申请已提交",
    "data": {
        "refund_id": 123456,
        "status": 0,               // 待审核
        "is_auto_approved": false, // 是否自动通过
        "estimated_refund_amount": 256,
        "estimated_arrival_time": "预计2小时内审核完成"
    }
}
```

---

### 8.2 查询退款状态

**接口**: `GET /api/refund/status`

**请求参数**:
```
refund_id=123456
```

**响应**:
```json
{
    "code": 0,
    "data": {
        "refund_id": 123456,
        "order_id": 2025011500123,
        "status": 30,  // 已同意
        "status_text": "退款申请已通过",
        "refund_amount": 256,
        "service_fee": 64,
        "actual_refund_amount": 256,
        "estimated_arrival_time": "预计1-3个工作日到账",
        "created_at": "2025-01-20 10:00:00",
        "review_time": "2025-01-20 12:30:00",
        "refund_time": null,
        "status_logs": [
            {
                "status": 0,
                "status_text": "待审核",
                "time": "2025-01-20 10:00:00"
            },
            {
                "status": 20,
                "status_text": "人工审核中",
                "time": "2025-01-20 10:00:05"
            },
            {
                "status": 30,
                "status_text": "已同意",
                "time": "2025-01-20 12:30:00",
                "remark": "根据退改规则,使用前1天退款扣除20%手续费"
            }
        ]
    }
}
```

---

### 8.3 客服审核退款

**接口**: `POST /api/admin/refund/review`

**请求参数**:
```json
{
    "refund_id": 123456,
    "action": "approve",  // approve同意, reject拒绝, request_info需要补充资料
    "actual_refund_amount": 256,  // action=approve时必填
    "review_remark": "根据退改规则扣除20%手续费",
    "reject_reason": null  // action=reject时必填
}
```

**响应**:
```json
{
    "code": 0,
    "msg": "审核成功",
    "data": {
        "refund_id": 123456,
        "status": 30,  // 已同意
        "actual_refund_amount": 256
    }
}
```

---

## 九、关键业务逻辑伪代码

### 9.1 退款申请自动判断逻辑

```python
def process_refund_application(refund_request):
    """
    处理退款申请,判断是自动退款还是人工审核
    """
    # 1. 获取订单信息
    order = get_order(refund_request.order_id)

    # 2. 自动退款条件判断
    if check_auto_refund_conditions(order, refund_request):
        # 满足自动退款条件
        refund_request.status = 10  # 自动通过
        refund_request.is_auto_approved = True
        refund_request.actual_refund_amount = order.total_amount
        refund_request.service_fee = 0

        # 自动流转到退款中状态
        process_refund_payment(refund_request)

        # 记录日志
        log_refund_status_change(refund_request, 0, 10, 'System', '满足自动退款条件')

        return {
            'is_auto_approved': True,
            'message': '退款已自动通过,预计1-3个工作日到账'
        }
    else:
        # 需要人工审核
        refund_request.status = 20  # 人工审核中
        refund_request.is_auto_approved = False

        # 推送到客服工作台
        push_to_customer_service_queue(refund_request)

        # 记录日志
        log_refund_status_change(refund_request, 0, 20, 'System', '不满足自动退款条件,转人工审核')

        return {
            'is_auto_approved': False,
            'message': '退款申请已提交,预计2小时内审核完成'
        }


def check_auto_refund_conditions(order, refund_request):
    """
    检查是否满足自动退款条件
    """
    # 条件1:使用日期前3天(不含)
    days_before_use = (order.use_date - datetime.now()).days
    if days_before_use < 3:
        return False

    # 条件2:订单未核销
    if order.verification_status == 'used':
        return False

    # 条件3:首次申请退款
    if count_refund_requests(order.order_id) > 0:
        return False

    # 条件4:特殊情况(雪场停运、系统故障)
    if check_special_situations(order):
        return True

    # 条件5:风控检查
    if check_risk_control(order.user_id):
        return False

    return True


def check_special_situations(order):
    """
    检查特殊情况(自动退款豁免)
    """
    # 雪场停运
    if check_resort_closure(order.resort_id, order.use_date):
        return True

    # 系统故障
    if check_system_failure(order.order_id):
        return True

    return False
```

---

## 十、用户端退款界面

### 10.1 订单详情页-发起退款

```
订单详情

┌────────────────────────────────────┐
│ [封面图]                            │
│ 成人全日票-平日                     │
│ 万龙滑雪场                          │
│                                    │
│ 订单号:2025011500123               │
│ 使用日期:2025-01-22                │
│ 订单状态:未使用                     │
│ 订单金额:¥320                       │
│                                    │
│ [申请退款] [联系客服]               │
└────────────────────────────────────┘
```

### 10.2 退款申请表单

```
申请退款

┌────────────────────────────────────┐
│ 订单信息                            │
├────────────────────────────────────┤
│ 产品:成人全日票-平日                │
│ 使用日期:2025-01-22                │
│ 订单金额:¥320                       │
└────────────────────────────────────┘

┌────────────────────────────────────┐
│ 退款原因 *                          │
├────────────────────────────────────┤
│ ○ 临时有事无法前往                  │
│ ○ 行程变更                          │
│ ○ 天气原因                          │
│ ○ 其他                              │
│                                    │
│ [详细说明]                          │
│ 请输入退款原因...                   │
│                                    │
│ [上传凭证]                          │
│ (选填,如机票改签凭证等)             │
└────────────────────────────────────┘

┌────────────────────────────────────┐
│ 退款说明                            │
├────────────────────────────────────┤
│ 根据退改规则:                       │
│ • 使用前3天(不含):免费退改           │
│ • 使用前1-2天:扣除20%手续费          │
│ • 使用当天:不可退改                 │
│                                    │
│ 您的订单距离使用日期还有2天         │
│ 预计退款金额:¥256(扣除20%手续费)    │
│ 预计到账时间:审核通过后1-3个工作日  │
└────────────────────────────────────┘

[提交退款申请]
```

### 10.3 退款进度页

```
退款进度

┌────────────────────────────────────┐
│ 退款申请已提交                      │
│ 预计2小时内审核完成                 │
│                                    │
│ 退款金额:¥256                       │
│ (原价¥320 - 手续费¥64)              │
└────────────────────────────────────┘

┌────────────────────────────────────┐
│ 进度跟踪                            │
├────────────────────────────────────┤
│ ✅ 2025-01-20 10:00                │
│    提交退款申请                     │
│                                    │
│ ✅ 2025-01-20 10:00                │
│    进入审核队列                     │
│                                    │
│ 🔄 审核中...                        │
│    预计2小时内完成                  │
│                                    │
│ ⏳ 退款中                           │
│    审核通过后自动退款               │
│                                    │
│ ⏳ 退款成功                         │
│    预计1-3个工作日到账              │
└────────────────────────────────────┘

[取消退款申请] [联系客服]
```

### 10.4 退款成功页

```
退款成功

┌────────────────────────────────────┐
│ ✅ 退款已到账                       │
│                                    │
│ 退款金额:¥256                       │
│ 到账时间:2025-01-22 15:30           │
│ 退款方式:原路退回支付宝             │
└────────────────────────────────────┘

┌────────────────────────────────────┐
│ 退款明细                            │
├────────────────────────────────────┤
│ 订单金额:¥320                       │
│ 手续费:¥64(20%)                     │
│ 实际退款:¥256                       │
└────────────────────────────────────┘

[返回首页] [继续浏览产品]
```

---

## 十一、通知消息设计

### 11.1 退款状态变更推送

| 状态 | 推送渠道 | 消息模板 |
|------|---------|---------|
| 自动通过 | APP推送+短信 | 【雪哒APP】您的退款申请已通过,退款金额¥{amount}预计1-3个工作日到账 |
| 人工审核中 | APP推送 | 【雪哒APP】您的退款申请已提交,预计2小时内审核完成 |
| 已同意 | APP推送+短信 | 【雪哒APP】退款申请已通过,退款金额¥{amount}(扣除{fee_rate}%手续费),预计1-3个工作日到账 |
| 已拒绝 | APP推送+短信 | 【雪哒APP】退款申请被拒绝,原因:{reason}。如有疑问请联系客服400-xxx-xxxx |
| 退款成功 | APP推送+短信 | 【雪哒APP】退款成功,¥{amount}已退回您的{pay_method}账户,请注意查收 |
| 退款失败 | APP推送 | 【雪哒APP】退款处理失败,客服将尽快为您处理。如有疑问请联系400-xxx-xxxx |

---

## 十二、关键指标监控

### 12.1 退款指标

| 指标 | 统计周期 | 阈值 | 说明 |
|------|---------|------|------|
| 退款率 | 日/周/月 | <10% | 退款订单数/总订单数 |
| 自动退款率 | 日 | >60% | 自动通过退款数/总退款数 |
| 人工审核时长 | 日 | <2小时 | 从[人工审核中]到[已同意/已拒绝]的平均时长 |
| 退款到账时长 | 日 | <3天 | 从[退款中]到[退款成功]的平均时长 |
| 退款拒绝率 | 周 | <20% | 拒绝退款数/总退款申请数 |
| 退款争议率 | 月 | <5% | 退款后投诉数/总退款数 |

### 12.2 异常监控

- 单用户7天内退款次数≥3次 → 风控标记
- 单日退款率>15% → 预警(可能是产品/系统问题)
- 人工审核积压>50单 → 预警(增加客服人力)
- 退款接口失败率>5% → 预警(检查支付接口)

---

## 总结

这套退款流程设计的核心特点:

1. **自动化优先**:满足条件的退款自动处理,减少人工成本
2. **规则清晰**:用户、客服、系统都清楚知道什么情况该怎么处理
3. **用户友好**:流程透明,状态实时更新,减少用户焦虑
4. **灵活处理**:人工审核兜底,处理特殊情况
5. **数据可追溯**:完整的状态流转日志,方便排查问题
6. **风控严密**:异常行为标记,防止滥用退款
7. **支持部分退款**:连续购买的多日订单可按天退款

通过自动退款机制,预计可以让60%以上的退款申请无需人工介入,大幅降低客服工作量,同时提升用户体验。